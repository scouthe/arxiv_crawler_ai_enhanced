name: arXiv-crawler-ai-enhanced

on:
  schedule:
    - cron: "30 1 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        
      - name: Crawl arXiv papers and generate AI-enhanced content
        id: crawl_step
        env:
          # --- API Configuration (from GitHub Secrets) ---
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          MODEL_NAME: ${{ secrets.MODEL_NAME || 'deepseek-chat' }}
          
          # --- Crawler Configuration (from GitHub Variables) ---
          # å¿…é¡»æ˜¾å¼æ˜ å°„ï¼Œå¦åˆ™Pythonè„šæœ¬æ— æ³•è¯»å–GitHubè®¾ç½®çš„Variables
          CRAWL_ALL: ${{ vars.CRAWL_ALL }}
          CRAWL_DATE: ${{ vars.CRAWL_DATE }}
          MAX_WORKERS: ${{ vars.MAX_WORKERS }}
          CATEGORY_BLACKLIST: ${{ vars.CATEGORY_BLACKLIST }}
          CATEGORY_WHITELIST: ${{ vars.CATEGORY_WHITELIST }}
          OPTIONAL_KEYWORDS: ${{ vars.OPTIONAL_KEYWORDS }}
          TRANS_TO: ${{ vars.TRANS_TO }}
          PROXY: ${{ vars.PROXY }}
          STEP: ${{ vars.STEP }}
        run: |
          today=$(date -u "+%Y-%m-%d")
          echo "ğŸš€ Starting to crawl $today arXiv papers..."
          
          # Print Configuration (Hide Sensitive Info)
          echo -e "\n--- API Configuration ---"
          echo "OPENAI_API_KEY: ${OPENAI_API_KEY:+[SET]}"
          echo "OPENAI_BASE_URL: ${OPENAI_BASE_URL:-[NOT SET]}"
          echo "MODEL_NAME: ${MODEL_NAME:-[NOT SET]}"
          echo -e "-------------------------\n"
          
          # Check if today's file exists, delete if found
          if [ -f "data/${today}.jsonl" ]; then
            echo "ğŸ—‘ï¸  Found existing today's file, deleting for fresh start..."
            rm "data/${today}.jsonl"
          else
            echo "ğŸ“ Today's file doesn't exist, ready to create new one..."
          fi
          
          # Run the python script
          python run_crawler.py
          
          # Check if crawling was successful
          if [ ! -f "data/${today}.jsonl" ]; then
            echo "âŒ Crawling failed, no data file generated"
            exit 1
          fi
          
          echo "crawl_date=$today" >> $GITHUB_OUTPUT
          echo "âœ… Crawling completed"
        
      - name: Update file list
        run: |
          echo "Updating file list..."
          ls data/*.jsonl | sed 's|data/||' > assets/file-list.txt
          echo "File list updated"

      - name: Generate password hash and inject into config
        run: |
          echo "ğŸ” Generating password hash for authentication..."

          # å°è¯•ä» .env æ–‡ä»¶è¯»å–å¯†ç ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™å°è¯•è¯»å– Secrets
          # æ³¨æ„ï¼šé€šå¸¸ä¸å»ºè®®å°†åŒ…å«å¯†ç çš„ .env æäº¤åˆ°ä»“åº“
          if [ -f ".env" ]; then
            PASSWORD=$(grep -E "^ACCESS_PASSWORD=" .env | cut -d'=' -f2 | sed 's/"//g')
          else
            # å¦‚æœ .env ä¸å­˜åœ¨ï¼Œå°è¯•ä» GitHub Secrets è¯»å–
            PASSWORD="${{ secrets.ACCESS_PASSWORD }}"
          fi

          if [ -z "$PASSWORD" ]; then
            echo "âš ï¸  WARNING: ACCESS_PASSWORD not set (checked .env and Secrets)"
            PASSWORD_HASH="DISABLED_NO_PASSWORD_SET_IN_ENV"
          else
            PASSWORD_HASH=$(echo -n "$PASSWORD" | openssl dgst -sha256 -hex | awk '{print $2}')
            echo "ğŸ” Password protection is ENABLED"
          fi

          if [ -f "js/auth-config.js" ]; then
            sed -i "s/PLACEHOLDER_PASSWORD_HASH/$PASSWORD_HASH/" js/auth-config.js
            echo "âœ… Password hash injected"
          else
            echo "âŒ ERROR: js/auth-config.js not found!"
            exit 1
          fi

      - name: Summary
        run: |
          today=${{ steps.crawl_step.outputs.crawl_date }}
          echo "âœ… Workflow completed for $today"
        
      - name: Commit changes
        run: |
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "update: $(date -u '+%Y-%m-%d') arXiv papers"
        
      - name: Pull latest changes and push
        run: |
          git config pull.rebase true
          git config rebase.autoStash true
          
          for i in {1..3}; do
            echo "Push attempt $i"
            if git push origin main; then
              echo "âœ… Push successful"
              break
            else
              echo "âš ï¸ Push failed, pulling latest changes..."
              git pull origin main --no-edit || true
              if [ $i -eq 3 ]; then
                echo "âŒ Failed to push after 3 attempts"
                exit 1
              fi
            fi
          done