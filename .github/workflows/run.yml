name: arXiv-daily-ai-enhanced

on:
  schedule:
    - cron: "30 1 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        
      - name: Crawl arXiv papers and generate AI-enhanced content
        id: crawl_step
        env:
          # Get API config from GitHub Secrets
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          MODEL_NAME: ${{ secrets.MODEL_NAME || 'deepseek-chat' }}
          
          # Other configs from .env
          CRAWL_ALL: ${{ env.CRAWL_ALL }}
          CRAWL_DATE: ${{ env.CRAWL_DATE }}
          MAX_WORKERS: ${{ env.MAX_WORKERS }}
          CATEGORY_BLACKLIST: ${{ env.CATEGORY_BLACKLIST }}
          CATEGORY_WHITELIST: ${{ env.CATEGORY_WHITELIST }}
          OPTIONAL_KEYWORDS: ${{ env.OPTIONAL_KEYWORDS }}
          TRANS_TO: ${{ env.TRANS_TO }}
          PROXY: ${{ env.PROXY }}
          STEP: ${{ env.STEP }}
        run: |
          today=$(date -u "+%Y-%m-%d")
          echo "Starting to crawl $today arXiv papers..."
          
          # Check if today's file exists, delete if found
          if [ -f "data/${today}.jsonl" ]; then
            echo "üóëÔ∏è Found existing today's file, deleting for fresh start..."
            rm "data/${today}.jsonl"
          else
            echo "üìù Today's file doesn't exist, ready to create new one..."
          fi
          
          # Run the python script
          python run_crawler.py
          
          # Check if crawling was successful
          if [ ! -f "data/${today}.jsonl" ]; then
            echo "Crawling failed, no data file generated"
            exit 1
          fi
          
          echo "crawl_date=$today" >> $GITHUB_OUTPUT
          echo "Crawling completed"
        
      - name: Update file list
        run: |
          echo "Updating file list..."
          ls data/*.jsonl | sed 's|data/||' > assets/file-list.txt
          echo "File list updated"

      - name: Generate password hash and inject into config
        run: |
          echo "üîê Generating password hash for authentication..."

          if [ -f ".env" ]; then
            PASSWORD=$(grep -E "^ACCESS_PASSWORD=" .env | cut -d'=' -f2 | sed 's/"//g')
          else
            PASSWORD=""
          fi

          if [ -z "$PASSWORD" ]; then
            echo "‚ö†Ô∏è WARNING: ACCESS_PASSWORD not set in .env"
            PASSWORD_HASH="DISABLED_NO_PASSWORD_SET_IN_ENV"
          else
            PASSWORD_HASH=$(echo -n "$PASSWORD" | openssl dgst -sha256 -hex | awk '{print $2}')
            echo "üîê Password protection is ENABLED"
          fi

          if [ -f "js/auth-config.js" ]; then
            sed -i "s/PLACEHOLDER_PASSWORD_HASH/$PASSWORD_HASH/" js/auth-config.js
            echo "‚úÖ Password hash injected"
          else
            echo "‚ùå ERROR: js/auth-config.js not found!"
            exit 1
          fi

      - name: Summary
        run: |
          today=${{ steps.crawl_step.outputs.crawl_date }}
          echo "‚úÖ Workflow completed for $today"
        
      - name: Commit changes
        run: |
          if [ -f ".env" ]; then
            EMAIL=$(grep -E "^EMAIL=" .env | cut -d'=' -f2 | sed 's/"//g')
            NAME=$(grep -E "^NAME=" .env | cut -d'=' -f2 | sed 's/"//g')
          else
            EMAIL="github-actions[bot]@users.noreply.github.com"
            NAME="github-actions[bot]"
          fi
          
          git config --global user.email "$EMAIL"
          git config --global user.name "$NAME"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "update: $(date -u '+%Y-%m-%d') arXiv papers"
        
      - name: Pull latest changes and push
        run: |
          git config pull.rebase true
          git config rebase.autoStash true
          
          for i in {1..3}; do
            echo "Push attempt $i"
            if git push origin main; then
              echo "Push successful"
              break
            else
              echo "Push failed, pulling latest changes..."
              git pull origin main --no-edit || true
              if [ $i -eq 3 ]; then
                echo "Failed to push after 3 attempts"
                exit 1
              fi
            fi
          done