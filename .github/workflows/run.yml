# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: arXiv-daily-ai-enhanced

on:
  schedule:
    - cron: "30 1 * * *"
  workflow_dispatch:


jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Crawl arXiv papers and generate AI-enhanced content
      id: crawl_step
      run: |
        today=$(date -u "+%Y-%m-%d")
        echo "å¼€å§‹çˆ¬å– $today çš„arXivè®ºæ–‡... / Starting to crawl $today arXiv papers..."
        
        # æ‰“å°ç¯å¢ƒå˜é‡é…ç½® / Print environment variable configuration
        echo "\n--- ç¯å¢ƒå˜é‡é…ç½® ---
CRAWL_ALL: ${CRAWL_ALL:-false}
CRAWL_DATE: ${CRAWL_DATE:-}
MAX_WORKERS: ${MAX_WORKERS:-4}
CATEGORY_BLACKLIST: ${CATEGORY_BLACKLIST:-}
CATEGORY_WHITELIST: ${CATEGORY_WHITELIST:-}
OPTIONAL_KEYWORDS: ${OPTIONAL_KEYWORDS:-}
TRANS_TO: ${TRANS_TO:-}
PROXY: ${PROXY:-}
STEP: ${STEP:-50}
------------------\n"
        
        # æ£€æŸ¥ä»Šæ—¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚å­˜åœ¨åˆ™åˆ é™¤ / Check if today's file exists, delete if found
        if [ -f "data/${today}.jsonl" ]; then
            echo "ğŸ—‘ï¸ å‘ç°ä»Šæ—¥æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ­£åœ¨åˆ é™¤é‡æ–°ç”Ÿæˆ... / Found existing today's file, deleting for fresh start..."
            rm "data/${today}.jsonl"
            echo "âœ… å·²åˆ é™¤ç°æœ‰æ–‡ä»¶ï¼šdata/${today}.jsonl / Deleted existing file: data/${today}.jsonl"
        else
            echo "ğŸ“ ä»Šæ—¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå‡†å¤‡æ–°å»º... / Today's file doesn't exist, ready to create new one..."
        fi
        
        # ä½¿ç”¨run_crawler.pyè„šæœ¬ï¼Œä».envæ–‡ä»¶è¯»å–æ‰€æœ‰é…ç½®
        python run_crawler.py
        
        # æ£€æŸ¥çˆ¬å–æ˜¯å¦æˆåŠŸ / Check if crawling was successful
        if [ ! -f "data/${today}.jsonl" ]; then
            echo "çˆ¬å–å¤±è´¥ï¼Œæœªç”Ÿæˆæ•°æ®æ–‡ä»¶ / Crawling failed, no data file generated"
            exit 1
        fi
        
        echo "crawl_date=$today" >> $GITHUB_OUTPUT
        echo "çˆ¬å–å®Œæˆ / Crawling completed"
        
    - name: Update file list
      run: |
        echo "æ›´æ–°æ–‡ä»¶åˆ—è¡¨... / Updating file list..."
        ls data/*.jsonl | sed 's|data/||' > assets/file-list.txt
        echo "æ–‡ä»¶åˆ—è¡¨æ›´æ–°å®Œæˆ / File list updated"

    - name: Generate password hash and inject into config
      run: |
        echo "ğŸ” Generating password hash for authentication..."

        # ä».envæ–‡ä»¶è¯»å–å¯†ç 
        if [ -f ".env" ]; then
          PASSWORD=$(grep -E "^ACCESS_PASSWORD=" .env | cut -d'=' -f2 | sed 's/"//g')
        else
          PASSWORD=""
        fi

        if [ -z "$PASSWORD" ]; then
          echo "âš ï¸  WARNING: ACCESS_PASSWORD not set in .env"
          echo "âš ï¸  Password protection will be DISABLED"
          echo "âš ï¸  To enable password protection, add ACCESS_PASSWORD in .env"
          echo "â„¹ï¸  Website will remain publicly accessible without authentication"

          # Use a special value that will disable authentication
          PASSWORD_HASH="DISABLED_NO_PASSWORD_SET_IN_ENV"
        else
          # Generate SHA-256 hash using openssl
          PASSWORD_HASH=$(echo -n "$PASSWORD" | openssl dgst -sha256 -hex | awk '{print $2}')
          echo "âœ… Password hash generated successfully"
          echo "âœ… Hash length: ${#PASSWORD_HASH} characters"
          echo "ğŸ” Password protection is ENABLED"
        fi

        # Inject hash into auth-config.js
        if [ -f "js/auth-config.js" ]; then
          sed -i "s/PLACEHOLDER_PASSWORD_HASH/$PASSWORD_HASH/" js/auth-config.js
          echo "âœ… Password hash injected into js/auth-config.js"
        else
          echo "âŒ ERROR: js/auth-config.js not found!"
          exit 1
        fi

        echo "ğŸ” Authentication setup complete"

    - name: Summary
      run: |
        today=${{ steps.crawl_step.outputs.crawl_date }}
        echo "âœ… å·¥ä½œæµå®Œæˆï¼šæˆåŠŸçˆ¬å–å¹¶å¤„ç† $today çš„arXivè®ºæ–‡ / Workflow completed: Successfully crawled and processed $today arXiv papers"
        
    - name: Commit changes
      run: |
        # ä».envæ–‡ä»¶è¯»å–Gité…ç½®
        if [ -f ".env" ]; then
          EMAIL=$(grep -E "^EMAIL=" .env | cut -d'=' -f2 | sed 's/"//g')
          NAME=$(grep -E "^NAME=" .env | cut -d'=' -f2 | sed 's/"//g')
        else
          EMAIL="github-actions[bot]@users.noreply.github.com"
          NAME="github-actions[bot]"
        fi
        
        git config --global user.email "$EMAIL"
        git config --global user.name "$NAME"
        git add .
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤ / Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤ / No changes to commit"
          exit 0
        fi
        git commit -m "update: $(date -u '+%Y-%m-%d') arXiv papers"
        echo "å˜æ›´å·²æäº¤ / Changes committed"
        
    - name: Pull latest changes and push
      run: |
        # è®¾ç½®Gité…ç½®ä»¥å¤„ç†è‡ªåŠ¨åˆå¹¶ / Set Git config for automatic merging
        git config pull.rebase true
        git config rebase.autoStash true
        
        # å°è¯•æ¨é€ï¼Œå¦‚æœå¤±è´¥åˆ™æ‹‰å–å¹¶é‡è¯• / Try to push, if failed then pull and retry
        for i in {1..3}; do
          echo "æ¨é€å°è¯• $i / Push attempt $i"
          if git push origin main; then
            echo "æ¨é€æˆåŠŸ / Push successful"
            break
          else
            echo "æ¨é€å¤±è´¥ï¼Œæ‹‰å–æœ€æ–°å˜æ›´... / Push failed, pulling latest changes..."
            git pull origin main --no-edit || true
            if [ $i -eq 3 ]; then
              echo "3æ¬¡å°è¯•åæ¨é€å¤±è´¥ / Failed to push after 3 attempts"
              exit 1
            fi
          fi
        done